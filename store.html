<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>图库 | 图床工具</title>
    <link rel="icon" href="https://images.oldmoon.top/images/dingdangdog/dingdangdog1679378444620.png"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link href="./store.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
</head>

<body style="background-color: #eeeeea;">
<div class="form-group" style="text-align: center;">
    <h1 style="display: flex; justify-content: center">
        <img src="https://images.oldmoon.top/images/dingdangdog/dingdangdog1679378444620.png" width="40px"/>
        &nbsp;图库 | 图床工具
    </h1>
    <button onclick="exportAll()">导出全部图片</button>

    <div id="image-container" style="width: 80vw; margin: 0 auto;">

    </div>
    <button id="show-more" onclick="showMore()">显示更多</button>

    <div class="overlay" id="overlay">
        <img src="" alt="Fullscreen Image" class="fullscreen-image" id="fullscreen-image">
        <span class="close-button" id="close-button">&times;</span>
    </div>

    <div id="manager-menu">
        <div class="menu" id="show-big">查看大图</div>
        <div class="menu" id="delete">删除</div>
    </div>
</div>
<script type="text/javascript">
    // 获取当前网页的协议（http 或 https）
    const protocol = window.location.protocol;
    // 获取当前网页的主机名和端口
    const host = window.location.host;
    const serverUrl = protocol + "//" + host;
    // 服务地址
    const baseApiUrl = serverUrl + "/api/";
    // 图片地址集合
    let images;
    // 控制当前显示的图片数量
    let nextShowNum = 10;
    // 下一次加载图片的索引
    let nextIndex = 0;
    // 密钥
    let key;
    window.onload = function () {
        key = window.localStorage.getItem("key");
        getImageList(key);
    }

    // 小图图片容器
    const imgContainer = $("#image-container");

    // 全屏容器
    const overlay = document.getElementById('overlay');
    // 全屏后的图片容器
    const fullscreenImage = document.getElementById('fullscreen-image');
    // 全屏后的关闭按钮
    const closeButton = document.getElementById('close-button');

    // 关闭按钮添加点击事件
    closeButton.addEventListener('click', () => {
        overlay.style.display = 'none';
    });
    // 全屏容器添加点击事件
    overlay.addEventListener('click', (event) => {
        if (event.target === overlay) {
            overlay.style.display = 'none';
        }
    });

    // 右键菜单容器
    const menus = document.getElementById('manager-menu');
    // 整个DOM元素，任意地方左键点击，则隐藏右键菜单，并上次右键的文件名
    document.addEventListener('click', (e) => {
        menus.style.display = 'none';
        window.localStorage.removeItem("clickImgId");
        window.localStorage.removeItem("clickImgSrc");
    });


    // 导出全部图片
    function exportAll() {
        window.open(baseApiUrl + "export?key=" + key);
    }

    // 打开图库
    async function getImageList(key) {
        $.ajax({
            url: baseApiUrl + "store/getImageList?key=" + key,
            type: "GET",
            headers: {
                'Access-Control-Allow-Origin': '*',
            },
            crossDomain: true,
            processData: false, // 告诉jQuery不要去处理发送的数据
            contentType: false, // 告诉jQuery不要去设置Content-Type请求头
            success: function (data) {
                if (data.code === 200) {
                    // 查询成功，保存图片列表，并初始化显示部分图片
                    images = data.imageList;
                    showImage(images);
                } else {
                    alert(data.message);
                }
            },
            error: function (data) {
                alert("System Error!");
            }
        });
    }

    function showImage(imageList) {
        if (imageList.length > 0) {
            for (let i = nextIndex; i < nextShowNum; i++) {
                // 创建一个新的 <img> 元素，并赋予一些属性
                const imageElement = document.createElement('img');
                imageElement.className = "mini-image";
                imageElement.src = imageList[i]; // 图片路径
                imageElement.style.width = "auto";
                imageElement.style.height = "20vh";
                imageElement.style.margin = "1vw";
                // 截取最后一节文件名作为ID
                let urls = imageList[i].split("/");
                imageElement.id = urls[urls.length - 1];
                // 将新图片（img元素）添加到图片容器
                imgContainer.append(imageElement);

                // 图片添加左键点击事件，显示大图
                imageElement.addEventListener('click', (e) => {
                    fullscreenImage.src = e.target.src;
                    overlay.style.display = 'block';
                });
                // 图片添加右键点击事件，显示管理菜单
                imageElement.addEventListener('contextmenu', (e) => {
                    // 阻止右键默认行为，并显示自定义菜单
                    e.preventDefault();
                    menus.style.display = "block";
                    menus.style.left = e.pageX + "px";
                    menus.style.top = e.pageY + "px";
                    // 记录当前点击的数据ID（图片名称）
                    window.localStorage.setItem("clickImgId", e.target.id);
                    window.localStorage.setItem("clickImgSrc", e.target.src);
                });
            }
        }
        // 如果所有图片加载完毕，隐藏【显示更多】按钮
        if (nextShowNum >= imageList.length) {
            document.getElementById("show-more").hide();
        }
        // 变更当前标识，为下一次显示做准备
        nextIndex = nextShowNum;
        nextShowNum += 10;
        if (nextShowNum >= imageList.length) {
            nextShowNum = imageList.length;
        }
    }

    function showMore() {
        showImage(images);
    }

    // 大图按钮
    const showBig = document.getElementById('show-big');
    showBig.addEventListener('click', () => {
        fullscreenImage.src = window.localStorage.getItem("clickImgSrc");
        overlay.style.display = 'block';
    });

    // 删除按钮
    const deleteMenu = document.getElementById('delete');
    deleteMenu.addEventListener('click', () => {
        alert('You clicked ：' + window.localStorage.getItem("clickImgId"));
    });
</script>
</body>
</html>